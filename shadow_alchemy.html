<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" />
<title>Shadow Alchemy</title></head><body></body>
<script src="taptapir/taptapir.js"></script>
<script type='text/sunsnake'>


set_orientation('horizontal')
set_background_color('#111')
set_window_color('black')

import narrator
import player
import levels

intro_story = `
Legend says this was the home of a powerful Alchemist.
---
The tower was once covered with gold, on every wall, making it attractive for adventurers.
But I belive, there is only one way it would be possible to aquire that much gold.
If you could make it.
`

main_menu = Scene(parent=camera.ui, name='main_menu', texture='alchemists_tower')
main_menu.on_enter = def():
    camera.overlay.alpha = 1
    camera.overlay.animate('alpha', 0, 2)
    start_button.enabled = False
    start_button.scale = .05
    # start_button.text_alpha = 0
    after .5:
        start_button.enabled = True
        start_button.animate('scale_x', .3, .2)
        after .2:
            start_button.animate('scale_y', .1, .2)
            # start_button.animate('text_alpha', .9, .5)

start_button = Button(parent=main_menu, scale=[.3,.1], color=color.black, alpha=.9, text='Play', text_color=color.orange, y=-.2,shadow=True, on_click=def():goto_scene('intro'))
main_menu.input = def input(key):
    if key == 'enter':
        start_button.on_click()

title = Button(parent=main_menu, text='Shadow Alchemy', z=-1, y=.2, color=color.clear, text_size=15, text_color=color.violet,)
# Entity(parent=main_menu, scale=2, color=color.black, alpha=.7)

intro = Scene(parent=camera.ui, name='intro', texture='alchemists_tower')
enter_dungeon_button = Button(parent=intro, scale=[.3,.1], color=color.black, alpha=.9, text='Enter Tower', text_color=color.azure, y=-.2,shadow=True, enabled=False, on_click=def():goto_scene('dungeon'))
intro.on_enter = def():
    def enter_dungeon():
        enter_dungeon_button.enabled = True
    narrator.narrate(intro_story, on_click=enter_dungeon)
intro.on_exit = def():
    # narrator.end()
    enter_dungeon_button.enabled = False


dungeon = Scene(name='dungeon')
dungeon.bg = Entity(parent=dungeon, texture='black_bg.gif', scale=[.16,.9], z=1)
dungeon.on_enable = def():
    print('go to dungeon')
    goto_level(0)
    camera.fov = 12
LEVEL_SIZE = [16,16]
TILES = Array2D(LEVEL_SIZE[0], LEVEL_SIZE[1])
h=0
s=0
v=.15
variation = [0,0,.002]
tile_parent = Entity(parent=dungeon, visible_self=False)


def goto_level(level_index):
    print('gotolevel:', levels[level_index])
    destroy(tile_parent)
    tile_parent = Entity(parent=dungeon, visible_self=False)
    # print(levels[level_index])
    # print('trimmed:', levels[level_index].trim())
    let lines = levels[level_index].trim().split('\n').reverse()
    # print('lines', lines)
    LEVEL_SIZE[1] = len(lines)
    LEVEL_SIZE[0] = len(lines[0])
    # level_grid = []
    TILES = Array2D(LEVEL_SIZE[0], LEVEL_SIZE[1])
    print('----- width', TILES.width)

    for y, line in lines:
        for x, char in line.split(''):
            tile_type = char
            # print(x,y, char)
 

            if char in ['.','@','E','b','m']:
                tint = hsv(h+random_int(0,10)*variation[0], s+random_int(0,10)*variation[1], v+random_int(0,10)*variation[2])
                tile = Entity(parent=tile_parent, scale=1, xy=[x,y], z=-1, color=tint, shadow=1, roundness=.015, scale=1.1, tile_type='a', ignore_collision=False, rotation=random_int(-10,10)*.1, walkable=True, tile_type=tile_type, text=tile_type, text_origin=[0,0], text_color=color.dark_gray, alpha=0, roundness=.5, scale=0, content=None)
                TILES.set(x, y, tile) 
                
            elif char == '█' and (y > 0 and lines[y-1][x] != '█'):
                tint = hsv(210+random_int(0,10)*variation[0], .4+random_int(0,10)*variation[1], .05)
                TILES.set(x, y, Entity(parent=tile_parent, scale=1, xy=[x,y], z=-1, color=tint, shadow=1, roundness=.015, scale=1.1, tile_type='a', ignore_collision=False, rotation=random_int(-10,10)*.1, alpha=0, content=None))
                
            
            if char == '@':
                print('move player to:', x, y)
                player.xy = tile.xy
                camera.xy = player.xy
                
            elif char == 'E':
                tile.walkable = False
                tile.content = Door(tile=tile, level_index=level_index)

            elif char == 'b':
                tile.content = Barrel(tile=tile)
                tile.walkable = False

             elif char == 'm':
                tile.content = Enemy(tile=tile, enemy_type='shadow_blob')
                tile.walkable = False

    player.goto_tile(TILES.get(player.x, player.y))

class Door extends Entity:
    constructor(settings):
        tile = settings['tile']
        super({parent:tile, color:hsv(20,.5,1), alpha:0, z:-1, text:'E'})
        this.level_index = settings['level_index']

    on_interact():
        goto_level(this.level_index+1)


class Barrel extends Entity:
    constructor(settings):
        tile = settings['tile']
        super({parent:tile, scale:[.7,.9], color:hsv(20,.5,.3), alpha:0, z:-1, text:'barrel'})
        this.looted = False

    on_interact():
        if not this.looted:
            print('loot barrel')
            this.text = ''
        else:
            print('already looted')
            return

class Enemy extends Entity:
    constructor(settings):
        tile = settings['tile']
        let enemy_type = settings['enemy_type']
        # super(dict(scale=[.7,.9], color=hsv(20,.5,.3), alpha=0, z=-1))
        super({parent:tile, scale:[.7,.9], color:hsv(0,.9,.8), alpha:0, z:-1, text:enemy_type})
        this.tile = tile
        this.hp = 3

    die():
        print('die')
        destroy(this)
        this.tile.walkable = True

    on_interact():
        print('interact')
        this.hp -= 1
        if this.hp > 0:
            print('enemy hp:', this.hp, '->', this.hp-1)
            this.alpha = 0
            this.animate('alpha', 1, .1)
        else:
            this.die()
        


cheats = Entity(visible_self=False)
cheats.input = def cheat_input(key):
    if int(key) in [0,1,2,3,4,5,6,7,8,9]:
        # print(key)
        scene_name = Object.keys(scene_handler.states)[int(key)]
        # print('cheat: goto_scene:', scene_name)
        goto_scene(scene_name)
        # print('---------', test_level)

# goto_scene(dungeon, False)
goto_scene(main_menu, False)

</script>
<script src="taptapir/sunsnake_compiler.js"></script></html>
